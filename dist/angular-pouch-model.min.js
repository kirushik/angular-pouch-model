/* angular-pouch-model - 0.0.1
 * promised based, $digest aware, object persistence layer for angularjs apps using PouchDB
 * http://marfarma.viewdocs.io/angular-pouch-model
 */
!function(){var a=angular.module("pouch-model",[]);a.provider("PouchModel",function(){var a={};validate.validators.simple=function(a,b){return validate.isDefined(a)?validate.isString(a)||validate.isNumber(a)?void 0:b.message||"is not a simple value":void 0},validate.validators.isFunction=function(a,b){return validate.isDefined(a)?"function"!=typeof a?b.message||"is not a function":void 0:void 0},this.$get=["$q","$db","$rootScope","$timeout",function(b,c,d){var e=function(a,b){a.$$phase||a.$root.$$phase?b():a.$apply(b)};validate.asyncValidate=function(a,c,d,e){var f,g,h,i,j,k,l,m=[];d=d||{};for(f in c){k=a[f],l=validate.result(c[f],k,a,f);for(i in l){if(h=validate.validators[i],!h)throw g=validate.format("Unknown validator %{name}",{name:i}),new Error(g);j=l[i],j=validate.result(j,k,a,f),j&&(g=h.call(h,k,j,f,a),validate.isDefined(g)&&(validate.isString(g)||validate.isArray(g)?m.push(b.when({attr:f,error:g})):m.push(g)))}}b.all(m).then(function(a){var b={},c=null;a.forEach(function(a){c=a.attr,validate.isString(a.error)&&(a.error=[a.error]),a.error&&a.error.length>0&&(b[c]=(b[c]||[]).concat(a.error))}),b=validate.fullMessages(b,d),Object.keys(b).length>0?e(b,null):e(null,null)},function(a){console.log("asyncValidate error:"),console.log(a)})},validate.validators.unique=function(c,f,g,h){var i,k=b.defer();return validate.isDefined(c)?(!validate.isDefined(f.on)&&validate.isDefined(h.apm_type)&&(f.on=h.apm_type),validate.isDefined(f.on)&&!validate.contains(a,f.on)?(i="^Validation 'unique' error: %{on} is not a PouchModel registered type",i=validate.format(i,{on:f.on}),e(d,function(){k.resolve({attr:g,error:i})})):j(h,g,function(a,b){a?(i=validate.isDefined(err.message)?err.message:err,e(d,function(){k.resolve({attr:g,error:i})})):(b||(i=f.message||"is not unique",e(d,function(){k.resolve({attr:g,error:i})})),e(d,function(){k.resolve({attr:g})}))}),k.promise):void 0},validate.validators.exists=function(c,f,g){var h,i=b.defer();return validate.isDefined(c)?(validate.isDefined(f.type)&&!validate.contains(a,f.type)?(h="^Validation 'exists' error: %{type} is not a PouchModel registered type",h=validate.format(h,{type:f.type}),e(d,function(){i.resolve({attr:g,error:h})})):validate.isDefined(f.property)?o(f.type,f.property,c,function(a,b){a?(h=validate.isDefined(a.message)?a.message:a,e(d,function(){i.resolve({attr:g,error:h})})):null===b?(h=f.message||"is not found",e(d,function(){i.resolve({attr:g,error:h})})):e(d,function(){i.resolve({attr:g})})}):(h="^Validation 'exists' error: %{property} is required",h=validate.format(h,{property:f.property}),e(d,function(){i.resolve({attr:g,error:h})})),i.promise):void 0},validate.validators.omits=function(c,f,g){var h,i=b.defer();return validate.isDefined(c)?(validate.isDefined(f.type)&&!validate.contains(a,f.type)?(h="^Validation 'omits' error: %{type} is not a PouchModel registered type",h=validate.format(h,{type:f.type}),e(d,function(){i.resolve({attr:g,error:h})})):validate.isDefined(f.property)?o(f.type,f.property,c,function(a,b){a?(h=validate.isDefined(a.message)?a.message:a,e(d,function(){i.resolve({attr:g,error:h})})):null===b?e(d,function(){i.resolve({attr:g})}):(h=f.message||"exists",e(d,function(){i.resolve({attr:g,error:h})}))}):(h="^Validation 'omits' error: %{property} is required",h=validate.format(h,{property:f.property}),e(d,function(){i.resolve({attr:g,error:h})})),i.promise):void 0};var f=function(a,b){var c=new a;return $.extend(!0,c,b),c},g=function(a,b,c,d){a||(b._id=c.id,b._rev=c.rev),d(a,b)},h=function(a,b){a._id=uuid(),c.post(a,function(c,d){g(c,a,d,b)})},i=function(b,d){var e,f={_id:{presence:!0,simple:!0},_rev:{presence:!0,simple:!0},apm_type:{presence:!0,simple:!0,inclusion:{within:a}}};e=validate(b,f),"undefined"!=typeof e?g(e,b,null,d):c.put(b,function(a,c){g(a,b,c,d)})},j=function(a,b,d){var e={obj:a,property:b,callback:d},f={obj:{presence:!0},property:{presence:!0},callback:{presence:!0,isFunction:!0}};if(err=validate(e,f),"undefined"!=typeof err)d(err,null);else{var g="";g=a._id&&a._id.length>0?"apm_type = '"+a.apm_type+"' and "+b+" = '"+a[b]+"' and _id != '"+a._id+"'":"apm_type = '"+a.apm_type+"' and "+b+" = '"+a[b]+"'";var h={select:"1",where:g};c.gql(h,function(a,b){a?d(a,null):b.rows.length>0?d(null,!1):d(null,!0)})}},k=function(a,b){n("",a,function(a,c){b(a,c)})},l=function(b,c){var d;return c.length>0?b.apm_type===c&&(d=f(a[b.apm_type],b)):d=b,d},m=function(a,b,d){var e={select:"*",where:b};c.gql(e,function(b,c){var f;b?d(b,null):(1===c.rows.length?f=l(c.rows[0],a):c.rows.length>1?(f=[],c.rows.forEach(function(b){e=l(b,a),f.push(e)})):f=null,d(null,f))})},n=function(a,b,c){var d="apm_type = '"+a+"' and _id = '"+b+"'";0===a.length&&(d="_id = '"+b+"'"),m(a,d,c)},o=function(a,b,c,d){var e="apm_type = '"+a+"' and "+b+" = '"+c+"'";m(a,e,d)},p=function(a){var b={};for(var c in a)a.hasOwnProperty(c)&&"function"!=typeof a[c]&&(b[c]=angular.copy(a[c]));return b},q=function(a,b){n(a.apm_type,a._id,function(c,d){c?b(c,null):null===d?(err={},err.message="Existing object with id: "+a._id+"and  type '"+a.apm_type+" not found.",b(err,null)):b(null,!0)})},r=function(b,c){var d={apm_type:{presence:!0,simple:!0,inclusion:{within:a}}};if("undefined"!=typeof b.apm_validations&&null!==b.apm_validations)for(var e in b.apm_validations)b.apm_validations.hasOwnProperty(e)&&(d[e]=angular.copy(b.apm_validations[e]));validate.asyncValidate(b,d,{},function(a){if(validate.isDefined(a))c(a,b);else{var d=p(b);""!==b._rev?q(b,function(a,e){e?i(d,function(a,b){a?c(a,b):(b._rev=d._rev,c(null,b))}):c(a,b)}):h(d,function(a,b){a?c(a,b):(b._id=d._id,b._rev=d._rev,c(null,b))})}})};this.setNew=function(b,c){var d,e={apm_type:b,value:c},f={apm_type:{presence:!0,simple:!0},value:{presence:!0,isFunction:!0}};return d=validate(e,f),"undefined"!=typeof d?d:(a[b]=c,void 0)};var s={};return s.getAll=function(c){var f,g=b.defer(),h={apm_type:c},i={apm_type:{presence:!0,simple:!0,inclusion:{within:a}}};if(f=validate(h,i),"undefined"!=typeof f)e(d,function(){g.reject(f)});else{var j="apm_type = '"+c+"'";m(c,j,function(a,b){a?e(d,function(){g.reject(a)}):e(d,function(){g.resolve(b)})})}return g.promise},s.newObj=function(c){var f,g=b.defer(),h={apm_type:{presence:!0,simple:!0,inclusion:{within:a}}};if(f=validate({apm_type:c},h),"undefined"!=typeof f)e(d,function(){g.reject(f)});else{var i=new a[c];i._id="",i.name="",i.apm_type=c,i._rev="",e(d,function(){g.resolve(i)})}return g.promise},s.saveObj=function(a){var c,f=b.defer();return"undefined"==typeof a?(c={},c.message="saveObj - error object undefined",e(d,function(){f.reject(c)})):r(a,function(a,b){a?e(d,function(){f.reject(a)}):e(d,function(){f.resolve(b)})}),f.promise},s.getById=function(c,f){var g,h=b.defer(),i={apm_type:c,_id:f};validate.prettify=function(a){return a};var j={apm_type:{presence:!0,simple:!0,inclusion:{within:a}},_id:{presence:!0,simple:!0}};return g=validate(i,j),"undefined"!=typeof g?e(d,function(){h.reject(g)}):n(c,f,function(a,b){a?e(d,function(){h.reject(a)}):e(d,function(){h.resolve(b)})}),h.promise},s.getByProperty=function(c,f,g){var h,i=b.defer(),j={apm_type:c,value:g,property:f},k={apm_type:{presence:!0,simple:!0,inclusion:{within:a}},property:{presence:!0,simple:!0},value:{presence:!0,simple:!0}};return h=validate(j,k),"undefined"!=typeof h?e(d,function(){i.reject(h)}):o(c,f,g,function(a,b){a?e(d,function(){i.reject(a)}):e(d,function(){i.resolve(b)})}),i.promise},s.getByGql=function(g){var h,i=b.defer(),j={select:"*",where:g},k={where:{presence:!0,simple:!0}};return h=validate(j,k),"undefined"!=typeof h?e(d,function(){i.reject(h)}):c.gql(j,function(b,c){var g=[];b?e(d,function(){i.reject(b)}):(c.rows.forEach(function(b){j=""!==b.apm_type?f(a[b.apm_type],b):b,g.push(j)}),e(d,function(){i.resolve(g)}))}),i.promise},s.Gql=function(a,f){var g,h=b.defer(),i={select:"*",where:f},j={select:{presence:!0,simple:!0},where:{presence:!0,simple:!0}};return g=validate(i,j),"undefined"!=typeof g?e(d,function(){h.reject(g)}):c.gql(i,function(a,b){a?e(d,function(){h.reject(a)}):e(d,function(){h.resolve(b)})}),h.promise},s.deleteObj=function(a){var f,g=b.defer(),h={_id:{presence:!0,simple:!0},_rev:{presence:!0,simple:!0}};return f=validate({obj:a},{obj:{presence:!0}}),"undefined"==typeof f&&(f=validate(a,h)),"undefined"!=typeof f?e(d,function(){g.reject(f)}):c.remove(a,function(a,b){a?e(d,function(){g.reject(a)}):e(d,function(){g.resolve(b)})}),g.promise},s.deleteById=function(a){var f=b.defer();return k(a,function(a,b){if(a)e(d,function(){f.reject(a)});else if(null!==b){c.remove(b,function(a,b){a?e(d,function(){f.reject(a)}):e(d,function(){f.resolve(b)})})}else a={status:404,error:"not_found",reason:"missing"},e(d,function(){f.reject(a)})}),f.promise},s.setNew=this.setNew,s.setInvalid=this.setInvalid,s}]})}();